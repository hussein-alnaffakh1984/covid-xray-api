<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>COVID X-ray Classification</title>

  <style>
    body{font-family:Arial, sans-serif;background:#f4f6f9;margin:0;padding:20px}
    .card{max-width:1100px;margin:0 auto;background:#fff;border-radius:18px;padding:22px 22px 26px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px}
    .logo{width:110px}
    .title{flex:1;text-align:center;font-size:34px;font-weight:800;margin-top:6px}
    .meta{min-width:320px;text-align:right;line-height:1.9}
    hr{border:none;border-top:1px solid #e6e8ee;margin:18px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:end}
    .box{border:1px solid #e6e8ee;border-radius:14px;padding:14px}
    label{display:block;font-weight:700;margin-bottom:10px}
    input[type="file"], input[type="number"]{width:100%;padding:10px;border:1px solid #d7dbe6;border-radius:10px}
    .btns{display:flex;gap:14px;justify-content:space-between;margin-top:14px;flex-wrap:wrap}
    button, a.btn{border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;min-width:220px}
    .btn-blue{background:#2f6fed;color:#fff}
    .btn-dark{background:#111;color:#fff}
    .btn-green{background:#16a34a;color:#fff}
    .result{margin-top:16px;border:1px dashed #cfd6ea;border-radius:14px;padding:14px;background:#fbfcff}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{background:#eef3ff;border-radius:999px;padding:6px 10px;font-weight:700}
    img.preview{max-width:100%;border-radius:14px;margin-top:12px;border:1px solid #e6e8ee}
    small{color:#667085}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.meta{min-width:auto}}
  </style>
</head>

<body>
  <div class="card">
    <div class="header">
      <div style="min-width:140px">
        <img class="logo" src="/static/logo.png" alt="Logo" />
      </div>

      <div class="title">COVID X-ray Classification (MobileNetV2)</div>

      <div class="meta">
        <div><b>الجامعة:</b> جامعة الكفيل</div>
        <div><b>الكلية:</b> كلية التقنيات الصحية والطبية</div>
        <div><b>القسم:</b> قسم الأشعة (Radiology Techniques)</div>
        <div><b>المرحلة:</b> الرابعة</div>
        <div><b>السنة الدراسية:</b> 2025-2026</div>
      </div>
    </div>

    <hr />

    <form id="xrayForm">
      <div class="grid">
        <div class="box">
          <label for="file">رفع صورة الأشعة (JPG/PNG)</label>
          <input id="file" name="file" type="file" accept="image/*" required />
          <small>يفضّل صورة واضحة للصدر (Chest X-ray).</small>
        </div>

        <div class="box">
          <label for="threshold">Threshold (العتبة)</label>
          <input id="threshold" name="threshold" type="number" step="0.01" min="0" max="1" value="0.50" />
          <small>القيمة الافتراضية: 0.50</small>
        </div>
      </div>

      <div class="btns">
        <!-- الزر الأزرق: افتح Swagger -->
        <a class="btn btn-blue" href="/docs" target="_blank">واجهة الـ API (Swagger)</a>

        <!-- تشخيص بدون مغادرة الصفحة -->
        <button class="btn btn-dark" type="submit">تشخيص الصورة</button>

        <!-- تحميل PDF -->
        <button class="btn btn-green" type="button" id="pdfBtn">تحميل تقرير PDF</button>
      </div>
    </form>

    <div class="result" id="resultBox" style="display:none">
      <div class="row">
        <div class="pill" id="predText">Prediction: -</div>
        <div class="pill" id="confText">Confidence: -</div>
        <div class="pill" id="probText">P(label=1): -</div>
      </div>

      <img id="preview" class="preview" alt="X-ray preview" style="display:none" />
      <div style="margin-top:10px">
        <small id="msg"></small>
      </div>
    </div>
  </div>

<script>
  const form = document.getElementById("xrayForm");
  const fileInput = document.getElementById("file");
  const thresholdInput = document.getElementById("threshold");

  const resultBox = document.getElementById("resultBox");
  const predText = document.getElementById("predText");
  const confText = document.getElementById("confText");
  const probText = document.getElementById("probText");
  const msg = document.getElementById("msg");
  const preview = document.getElementById("preview");
  const pdfBtn = document.getElementById("pdfBtn");

  fileInput.addEventListener("change", () => {
    const f = fileInput.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    preview.src = url;
    preview.style.display = "block";
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault(); // مهم: يمنع الانتقال لصفحة جديدة

    const f = fileInput.files[0];
    if (!f) return;

    msg.textContent = "جاري التشخيص...";
    resultBox.style.display = "block";

    const fd = new FormData();
    fd.append("file", f);
    fd.append("threshold", thresholdInput.value || "0.5");

    try {
      const res = await fetch("/predict", { method: "POST", body: fd });
      if (!res.ok) throw new Error("Server error: " + res.status);
      const data = await res.json();

      predText.textContent = "Prediction: " + data.prediction;
      confText.textContent = "Confidence: " + data.confidence + "%";
      probText.textContent = "P(label=1): " + data.prob_label1;

      msg.textContent = "تم التشخيص بنجاح.";
    } catch (err) {
      msg.textContent = "حدث خطأ: " + err.message;
    }
  });

  pdfBtn.addEventListener("click", async () => {
    const f = fileInput.files[0];
    if (!f) { alert("ارفع صورة أولاً."); return; }

    const fd = new FormData();
    fd.append("file", f);
    fd.append("threshold", thresholdInput.value || "0.5");

    msg.textContent = "جاري تجهيز PDF...";
    resultBox.style.display = "block";

    try {
      const res = await fetch("/report", { method: "POST", body: fd });
      if (!res.ok) throw new Error("Server error: " + res.status);

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "covid_xray_report.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();

      msg.textContent = "تم تحميل التقرير.";
    } catch (err) {
      msg.textContent = "فشل إنشاء PDF: " + err.message;
    }
  });
</script>

</body>
</html>
